define(["dojo/_base/declare","dojo/dom","dojo/dom-class","esri/tasks/support/Query","esri/tasks/QueryTask","esri/tasks/GeometryService","esri/tasks/support/ProjectParameters","esri/geometry/geometryEngineAsync","esri/Graphic","dojo/promise/all","dojo/query"],function(e,t,r,n,a,i,o,s,u,l,d){"use strict";return e("locationService.NewSearch",null,{constructor:function(e,t,r){this.address=e.name,this.addressID=e.feature.attributes.Ref_ID,this.addressGeometry=e.feature.geometry,this.containerList=r,this.template=t},getParcelInfo:function(e,t,r){var i=this,o=new n,s=new a({url:e});o.where="ADDRESSID ="+this.addressID,o.returnGeometry=!1,o.outFields=["PARCELID"],s.execute(o).then(function(e){if(e.features[0].attributes.PARCELID){var r=e.features[0].attributes.PARCELID,i=new n,o=new a({url:t});return i.where="PARCELID  ="+r,i.returnGeometry=!1,i.outFields=["*"],o.execute(i)}}).then(function(e){var t=e.features[0].attributes;i.parcelInfo=r.map(function(e){var r=iterationCopy(e);return r.queryPolygonCount=1,r.feature={},["displayValue1","displayValue2","displayValue3","displayValue4"].forEach(function(n){e.displayControl[n]?r.feature[e.displayControl[n]]=t[e.displayControl[n]]:r.displayControl[n]=""}),r}),i.appendToPage(i.parcelInfo)})},projectToStatePlane:function(e,t){t=new i(t);var r=new o({geometries:[this.addressGeometry],outSpatialReference:e});return t.project(r)},getNearestCityFacilityList:function(e){function t(e){var t=n.geometryStatePlane,r=e.map(function(e){return s.distance(t,e.geometry,"miles")}),a=new l(r);return a}function r(e){var t=e.map(function(e){return e.features.map(function(t){return t.layer=e.id,t})});return t.reduce(function(e,t){return e.concat(t)})}var n=this,a=r(e);t(a).then(function(t){var r=a.map(function(e,r){return e.distance=t[r],e});n.nearestCityFacilityList=e.map(function(e){var t=r.filter(function(t){return t.layer==e.id}).reduce(function(e,t){return e.distance<t.distance?e:t}),n=iterationCopy(e);return delete n.features,n.distance=t.distance.toFixed(2),n.queryPolygonCount=1,n.feature=t.attributes,n}),n.appendToPage(n.nearestCityFacilityList)})},getLocatedServiceZoneList:function(e){var t=this,r=new n({returnGeometry:!0,outFields:["*"],spatialRelationship:"intersects"});r.geometry=this.addressGeometry;var i=e.map(function(e){var t=new a({url:e.url});return t.execute(r)}),o=new l(i);o.then(function(r){t.serviceZoneList=e.map(function(e,t){var n=iterationCopy(e);return n.queryPolygonCount=r[t].features.length,n.queryPolygonCount>0&&(n.feature=r[t].features[0].attributes),n}),t.appendToPage(t.serviceZoneList)})},insertHtmlToPage:function(e,n){var a=n.filter(function(t){return t.containerID==e.id}),i=d("ul",t.byId(e.id))[0],o=d("li",i).map(function(e){return{displayID:e.attributes.index.value,resultHtml:e.outerHTML}});if(i.innerHTML=o.concat(a).sort(function(e,t){return e.displayID-t.displayID}).map(function(e){return e.resultHtml}).join(""),e.itemCount<=o.length+a.length&&d(".spinner-grow",e.id).forEach(function(e){0==r.contains(e,"d-none")&&r.add(e,"d-none")}),t.byId("ews-trash")||t.byId("ews-recycling")){var s=t.byId("ews_link");1==r.contains(s,"d-none")&&r.remove(s,"d-none")}},prepareHtmlData:function(e){var t={};return t.id=e.id,t.name=e.name,t.displayControl=e.displayControl,0==e.queryPolygonCount?(t.displayValue1="NULL",t.displayValue2="",t):(e.displayControl.displayDistance&&(t.distance=e.distance),"hardcode"==e.displayControl.hyperlinkType&&(t.displayControl.hardcode=e.displayControl.hardcode),["displayValue1","displayValue2","displayValue3","displayValue4"].forEach(function(r){e.displayControl[r]?t[r]=e.feature[e.displayControl[r]]:t[r]=""}),"googleMap"==e.displayControl.hyperlinkType&&(t.startAdd=this.address.replace(/\s|\t/g,"+"),t.endAdd=e.feature.ADDRESS.replace(/\s|\t/g,"+")),t)},appendToPage:function(e){var t=this,r=e.map(function(e){var r=t.prepareHtmlData(e),n=t.template.generateResultHtml(r);return{containerID:r.displayControl.containerID,displayID:r.displayControl.displayID,resultHtml:n}});t.containerList.forEach(function(e){t.insertHtmlToPage(e,r)})},getCrimeData:function(e){var r=new Date;r.setHours(0,0,0);var n=new Date(r.getTime()-1e3-5184e5),a=new Date(r.getTime()-11232e5),i="".concat(a.getFullYear(),"-",a.getMonth()+1,"-",a.getDate()),o="".concat(n.getFullYear(),"-",n.getMonth()+1,"-",n.getDate()),s={lat:this.addressGeometry.latitude,long:this.addressGeometry.longitude,start_date:i,end_date:o},u=t.byId("crimeData");u.innerHTML="",u.innerHTML=e(s);var l=u.children[0].src;t.byId("crime-map-title").innerHTML="".concat("Crime ( <time datetime='",i," 00:00'>",i.slice(5),"</time> to <time datetime='",o," 23:59'>",o.slice(5),"</time> )"),t.byId("open-crime-map").setAttribute("href",l)},showSubMap:function(e){var t=new u({geometry:this.addressGeometry,symbol:{type:"simple-marker",color:[226,119,40]}});e.graphics.removeAll(),e.graphics.add(t),e.center=[this.addressGeometry.longitude,this.addressGeometry.latitude],e.zoom=18}})});