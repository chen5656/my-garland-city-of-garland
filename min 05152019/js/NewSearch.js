define(["dojo/_base/declare","dojo/dom","dojo/promise/all","dojo/dom-class","esri/tasks/support/Query","esri/tasks/QueryTask","esri/tasks/GeometryService","esri/tasks/support/ProjectParameters","esri/geometry/geometryEngineAsync","esri/Graphic"],function(e,t,r,n,a,i,o,s,u,c){function l(e){var t={};for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);return t}var d=multilSearch_settings.mapService.address,m=multilSearch_settings.mapService.parcel,p=multilSearch_settings.mapService.geometry;return e("locationService.NewSearch",null,{constructor:function(e){this.addressId=e},getAddressInfo:function(){var e=this,t=new a,r=new i({url:d});return t.where="ADDRESSID ="+this.addressId,t.returnGeometry=!0,t.outFields=["*"],new Promise(function(n,a){r.execute(t).then(function(t){var r=t.features[0].attributes;e.parcelId=r.PARCELID,e.address="".concat(r.STREETNUM," ",r.STREETLABEL,", ",r.CITY,", ",r.STATE,", ",r.ZIPCODE),e.geometryStatePlane=t.features[0].geometry,n()})})},getParcelInfo:function(e){var t=this,r=new a,n=new i({url:m});return r.where="PARCELID  ="+this.parcelId,r.returnGeometry=!1,r.outFields=["*"],new Promise(function(a,i){n.execute(r).then(function(r){var n=r.features[0].attributes;t.parcelInfo=e.map(function(e){var t=l(e);return t.queryPolygonCount=1,t.feature={},["displayValue1","displayValue2","displayValue3","displayValue4"].forEach(function(r){e.displayControl[r]?t.feature[e.displayControl[r]]=n[e.displayControl[r]]:t.displayControl[r]=""}),t}),template.appendToPage(t.parcelInfo,t.address),a()})})},projectToSpatialReference:function(e,t){var r=new o(p),n=new s({geometries:e,outSpatialReference:t});return r.project(n)},getNearestCityFacilityList:function(e){function t(e,t){var n=e.map(function(e){return u.distance(t,e.geometry,"miles")}),a=new r(n);return a}function n(e){var t=e.map(function(e){return e.features.map(function(t){return t.layer=e.id,t})});return t.reduce(function(e,t){return e.concat(t)})}var a=this,i=n(e);t(i,this.geometryStatePlane).then(function(t){var r=i.map(function(e,r){return e.distance=t[r],e});a.nearestCityFacilityList=e.map(function(e){var t=r.filter(function(t){return t.layer==e.id}).reduce(function(e,t){return e.distance<t.distance?e:t}),n=l(e);return delete n.features,n.distance=t.distance.toFixed(2),n.queryPolygonCount=1,n.feature=t.attributes,n}),template.appendToPage(a.nearestCityFacilityList,a.address)})},getLocatedServiceZoneList:function(e){var t=this,n=new a({returnGeometry:!1,outFields:["*"],spatialRelationship:"intersects"});n.geometry=this.geometry;var o=e.map(function(e){var t=new i({url:e.url});return t.execute(n)}),s=new r(o);s.then(function(r){t.serviceZoneList=e.map(function(e,t){var n=l(e);return n.queryPolygonCount=r[t].features.length,n.queryPolygonCount>0&&(n.feature=r[t].features[0].attributes),n}),template.appendToPage(t.serviceZoneList,t.address)})},getCrimeData:function(){var e=new Date;e.setHours(0,0,0);var r=new Date(e.getTime()-1e3-5184e5),n=new Date(e.getTime()-11232e5),a="".concat(n.getFullYear(),"-",n.getMonth()+1,"-",n.getDate()),i="".concat(r.getFullYear(),"-",r.getMonth()+1,"-",r.getDate()),o={lat:this.geometry.latitude,long:this.geometry.longitude,start_date:a,end_date:i},s=t.byId("crimeData");s.innerHTML="",s.innerHTML=template.generateCrimeMapIframe(o)},addResultToMap:function(e){var t=new c({geometry:this.geometry,symbol:{type:"simple-marker",color:"#dc2533"},popupTemplate:{title:"Target",content:this.address}});e.graphics.removeAll(),e.graphics.add(t),e.center=[this.geometry.longitude,this.geometry.latitude]},showEWSLink:function(){var e=document.getElementById("ews_link");1==n.contains(e,"d-none")&&n.remove(e,"d-none")}})});